name: iOS CI Build & Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: macos-latest

    steps:
      - name: üß© Checkout Repository
        uses: actions/checkout@v4

      - name: üõ†Ô∏è Select Xcode 16
        run: |
          sudo xcode-select -s /Applications/Xcode_16.app
          echo "‚úÖ Using Xcode:"
          xcodebuild -version

      - name: üì± Prepare iOS Simulator
        run: |
          echo "üì± Listing available runtimes..."
          xcrun simctl list runtimes

          # Pick latest available iOS 18 runtime
          RUNTIME=$(xcrun simctl list runtimes | grep "iOS 18" | grep -v unavailable | tail -1 | awk '{print $NF}' | tr -d '()')
          echo "‚úÖ Using runtime: $RUNTIME"

          DEVICE_TYPE="com.apple.CoreSimulator.SimDeviceType.iPhone-16-Pro"
          echo "üì± Creating simulator..."
          DEVICE_ID=$(xcrun simctl create "iPhone-16-Pro-CI" "$DEVICE_TYPE" "$RUNTIME")
          echo "DEVICE_ID=$DEVICE_ID" >> $GITHUB_ENV

          echo "üöÄ Booting simulator..."
          xcrun simctl boot "$DEVICE_ID" || true
          xcrun simctl list devices | grep "$DEVICE_ID"

      - name: üß± Build App
        run: |
          echo "üèóÔ∏è Building Holdings_Assignment..."
          xcodebuild \
            -scheme "Holdings_Assignment" \
            -sdk iphonesimulator \
            -destination "platform=iOS Simulator,id=${DEVICE_ID}" \
            clean build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: üß™ Run Unit Tests
        run: |
          echo "üß™ Running tests..."
          xcodebuild \
            test \
            -scheme "Holdings_Assignment" \
            -sdk iphonesimulator \
            -destination "platform=iOS Simulator,id=${DEVICE_ID}" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: üßπ Cleanup Simulator
        if: always()
        run: |
          echo "üßπ Cleaning up simulator..."
          xcrun simctl shutdown "$DEVICE_ID" || true
          xcrun simctl delete "$DEVICE_ID" || true
